<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>CISCO IOS XE Orchestration</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@2.0.4"
        integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        integrity="sha384-k6kNCOc8w9Ut5RkjtMzwLBhf7IMihQPY0F4YsmnZ9f9HPH3YXwYgRNHAFam1np3k" crossorigin="anonymous" />
</head>

<body>
    <div id="logout-response" style="display: none;"></div>
    <div class="header-container">
        <h1>Orchestrate a CISCO router</h1>
        <button id="refresh" class="btn btn-primary btn-mode" hx-get="/dynamic-output/"
            hx-target="#interfaceTable tbody" hx-swap="innerHTML">
            Refresh interfaces list
        </button>
        <button id="logout" class="btn btn-danger btn-mode" hx-post="/logout/" hx-swap="none"
            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
            Logout
        </button>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="command-container">
                    <h3 class="text-center mb-4">Interface management</h3>
                    <div id="dataSection" class="command-container" style="display: block;">
                        <!-- Form for sub-interface management -->
                        <form id="cliForm" hx-post="/send-subinterface/" hx-trigger="submit" hx-target="#Resultat"
                            hx-swap="innerHTML" hx-headers='{"Content-Type": "application/json"}' hx-ext="json-enc"
                            onsubmit="console.log(JSON.stringify(Object.fromEntries(new FormData(this))))">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="interfaceName" class="form-label">Interface name</label>
                                <input type="text" name="interfaceName" id="interfaceName" class="form-control"
                                    placeholder="Example: GigabitEthernet0/1" required readonly>
                            </div>
                            <div class="mb-3">
                                <label for="ipAddress" class="form-label">IP Address</label>
                                <input type="text" name="ipAddress" id="ipAddress" class="form-control"
                                    placeholder="Example: 192.168.0.1" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="subnetMask" class="form-label">Subnet mask</label>
                                <input type="text" name="subnetMask" id="subnetMask" class="form-control"
                                    placeholder="Example: 255.255.255.0" disabled>
                            </div>
                            <div class="mb-3">
                                <label for="subInterface" class="form-label">Sub-interface</label>
                                <input type="text" name="subInterface" id="subInterface" class="form-control"
                                    placeholder="Example: 2" required disabled>
                            </div>
                            <div class="mb-3">
                                <label for="action" class="form-label">Action</label>
                                <select name="action" id="action" class="form-select" disabled>
                                    <option value="1">Create</option>
                                    <option value="1">Update</option>
                                    <option value="0">Delete</option>
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="radioCLI" value="cli"
                                    checked disabled>
                                <label class="form-check-label" for="radioCLI">
                                    CLI
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="mode" id="radioNETCONF"
                                    value="netconf" disabled>
                                <label class="form-check-label" for="radioNETCONF">
                                    NETCONF
                                </label>
                            </div>
                            {% if is_readwrite %}
                            <button type="submit" class="btn btn-primary">Send</button>
                            {% else %}
                            <button type="submit" class="btn btn-primary" disabled
                                style="opacity: 0.5; cursor: not-allowed;">
                                Send
                            </button>
                            {% endif %}
                        </form>
                        <div class="output" id="Output">
                            <p id="Resultat">Output results will be shown here</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="command-container">
                    <!-- Table for displaying router interfaces -->
                    <table id="interfaceTable" class="table">
                        <thead>
                            <tr>
                                <th>Interface</th>
                                <th>IP</th>
                                <th>Status</th>
                                <th>Protocol</th>
                                <th>Actions</th>
                            </tr>
                            <tr id="loadingRow" style="display: none;">
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </thead>
                        <tbody id="interfaceBody" hx-get="/dynamic-output/" hx-trigger="load" hx-target="this"
                            hx-swap="innerHTML">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script>
        // Show spinner for any request except add, update, delete actions
        document.body.addEventListener('htmx:beforeRequest', function (evt) {
            const elt = evt.detail.elt;
            if (
                elt.classList.contains('add') ||
                elt.classList.contains('update') ||
                elt.classList.contains('delete')
            ) {
                return;
            }
            const loadingRow = document.getElementById('loadingRow');
            if (loadingRow) {
                loadingRow.style.display = 'table-row';
            }
        });

        // After form submission, refresh the interface table
        document.body.addEventListener('htmx:afterRequest', function (event) {
            if (event.detail.requestConfig.path === '/send-subinterface/') {
                const body = document.getElementById('interfaceBody');
                function stopSpinner() {
                    document.getElementById('loadingRow').style.display = 'none';
                    body.removeEventListener('htmx:afterSwap', stopSpinner);
                }
                body.addEventListener('htmx:afterSwap', stopSpinner);
                htmx.ajax('GET', '/dynamic-output/', {
                    target: '#interfaceBody',
                    swap: 'innerHTML'
                });
            }
        });

        // Hide spinner after table update
        document.getElementById('interfaceBody').addEventListener('htmx:afterSwap', function () {
            document.getElementById('loadingRow').style.display = 'none';
        });

        // Manual sync with router on refresh button click
        document.getElementById('refresh').addEventListener('click', function () {
            fetch('/sync-router/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    router_ip: '172.16.10.11'
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Sync successful');
                    } else {
                        console.error('Sync failed:', data.message);
                    }
                })
                .catch(err => console.error('Error:', err));
        });

        // Handle logout redirect after HTMX POST
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            const path = evt.detail.requestConfig.path;
            const status = evt.detail.xhr.status;
            const responseText = evt.detail.xhr.responseText;
            if (path === '/logout/' && status === 200) {
                try {
                    const data = JSON.parse(responseText);
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        console.warn("No redirect in JSON response:", data);
                    }
                } catch (e) {
                    console.error("Logout JSON error:", e, "Response:", responseText);
                }
            }
        });
    </script>
</body>

</html>